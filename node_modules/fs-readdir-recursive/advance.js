var fs = require('fs')
var path = require('path')

module.exports = advance;

function advance(options) {
  if (!options) {
    options = {}
  }
  options = Object.assign({
    withDir: false,
    recurLinkDir: false,
    maxDepth: null
  }, options);
  function read(root, filter, files, prefix, depth = 0) {
    prefix = prefix || ''
    files = files || []
    filter = filter || (it => it)
    if (options.maxDepth != null && depth > options.maxDepth) {
      return
    }

    var dir = path.join(root, prefix)
    if (!fs.existsSync(dir)) return files
    if ((options.recurLinkDir ? fs.statSync : fs.lstatSync)(dir).isDirectory()) {
      depth++
      options.withDir && files.push(`${prefix}/`)
      fs.readdirSync(dir).filter(function (name, index) {
        return filter(name, index, dir)
      }).forEach(function (name) {
        read(root, filter, files, path.join(prefix, name), depth)
      })
    } else {
      files.push(prefix)
    }

    return files
  }
  return read;
}
